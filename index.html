<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ì¸µê°„ìˆ˜ì‚¬ëŒ€ M</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Black+Han+Sans&family=Noto+Sans+KR:wght@400;700&display=swap');

        :root {
            --cell-size: 50px;
            --cols: 5;
            --bg-color: #2c3e50;
            --ui-bg: rgba(0,0,0,0.8);
        }

        body {
            font-family: 'Noto Sans KR', sans-serif;
            background-color: var(--bg-color);
            color: white;
            text-align: center;
            margin: 0; padding: 0;
            display: flex; flex-direction: column; align-items: center;
            min-height: 100vh;
            user-select: none; touch-action: manipulation; overflow: hidden;
        }

        /* ìƒë‹¨ UI íŒ¨ë„ */
        .ui-panel {
            width: 100%; background: var(--ui-bg); padding: 15px 0;
            box-shadow: 0 5px 20px rgba(0,0,0,0.5); border-bottom: 2px solid #34495e;
            position: fixed; top: 0; z-index: 100; backdrop-filter: blur(5px);
        }

        .header-row {
            display: flex; justify-content: center; align-items: center; gap: 15px; margin-bottom: 10px;
        }

        h1 {
            font-family: 'Black Han Sans', sans-serif; color: #f1c40f;
            font-size: 1.6rem; margin: 0; text-shadow: 2px 2px 0 #000;
        }

        .btn-restart-big {
            background: #e74c3c; color: white; border: none; border-radius: 8px;
            padding: 8px 16px; font-family: 'Black Han Sans'; font-size: 1rem;
            cursor: pointer; box-shadow: 0 4px 0 #c0392b; transition: transform 0.1s;
        }
        .btn-restart-big:active { transform: translateY(4px); box-shadow: none; }

        .difficulty-bar { display: flex; justify-content: center; gap: 8px; margin-bottom: 8px; }
        .btn-diff {
            background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.3);
            color: #ccc; padding: 6px 14px; border-radius: 20px; font-size: 0.9rem; cursor: pointer;
        }
        .btn-diff.active { background: #f1c40f; color: #2c3e50; font-weight: bold; border-color: #f1c40f; }

        .status-bar { display: flex; justify-content: center; gap: 20px; font-size: 1rem; font-weight: bold; }
        .score-num { color: #2ecc71; font-size: 1.3rem; }

        /* ê²Œì„ ì˜ì—­ */
        .game-container {
            margin-top: 150px; flex-grow: 1; display: flex; flex-direction: column;
            align-items: center; justify-content: flex-start; width: 100%; 
            overflow-y: auto; padding-bottom: 160px; padding-top: 20px;
        }

        .building-container {
            background-color: #34495e; padding: 20px; border-radius: 8px;
            box-shadow: 0 15px 40px rgba(0,0,0,0.6); border: 4px solid #1a252f; position: relative;
        }
        .roof { position: absolute; top: -15px; left: -5px; right: -5px; height: 15px; background-color: #1a1a1a; border-radius: 5px 5px 0 0; }

        #game-board { display: grid; grid-template-columns: repeat(var(--cols), var(--cell-size)); gap: 5px; }

        .window {
            width: var(--cell-size); height: var(--cell-size);
            background-color: #111; border: 2px solid #000; border-bottom-width: 4px; border-radius: 4px;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            font-size: calc(var(--cell-size) * 0.45); font-weight: bold; 
            cursor: pointer; position: relative; transition: transform 0.1s;
        }
        .window:active { transform: scale(0.95); }
        .window.revealed { cursor: default; }
        .window.revealed.safe { background-color: #f5f6fa; border-color: #dcdde1; box-shadow: none; }
        .window.revealed.level-1 { background-color: #fff9c4; color: #fbc02d; border-color: #fbc02d; box-shadow: inset 0 0 10px #fff176; }
        .window.revealed.level-2 { background-color: #ffcc80; color: #e65100; border-color: #fb8c00; box-shadow: inset 0 0 10px #ffb74d; font-weight: 900; }
        .window.revealed.level-3 { background-color: #ef9a9a; color: #b71c1c; border-color: #c62828; box-shadow: inset 0 0 15px #e57373; animation: pulse-red 1.5s infinite; }
        @keyframes pulse-red { 0% { box-shadow: inset 0 0 5px #e57373; } 50% { box-shadow: inset 0 0 20px #e57373; } 100% { box-shadow: inset 0 0 5px #e57373; } }

        .noise-icon { font-size: 0.8em; margin-bottom: 2px; }
        .window.arrested { background-color: #2980b9 !important; color: white !important; border-color: #3498db; }
        .window.arrested .noise-icon { content: "ğŸ‘®â€â™‚ï¸"; font-size: 1.5em; }
        .window.angry { background-color: #e74c3c !important; color: white !important; animation: shake 0.4s; }
        .window.busted { background-color: #c0392b !important; color: white !important; border-color: #e74c3c; animation: shake 0.4s; }
        .window.busted .noise-icon { content: "ğŸ‘¹"; font-size: 1.5em; }
        @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-5px); } 75% { transform: translateX(5px); } }
        .window.safe-open { animation: flashSafe 0.5s; background-color: #dff9fb; }
        @keyframes flashSafe { 0% { background-color: #2980b9; } 100% { background-color: #dff9fb; } }

        /* í•˜ë‹¨ ì»¨íŠ¸ë¡¤ */
        .controls {
            position: fixed; bottom: 0; left: 0; right: 0;
            display: flex; justify-content: center; gap: 15px; z-index: 100;
            padding-bottom: 20px; padding-top: 20px;
            background: linear-gradient(to top, rgba(44, 62, 80, 1) 40%, rgba(44, 62, 80, 0));
        }
        .mode-btn {
            padding: 14px 28px; border-radius: 35px; border: none;
            font-family: 'Black Han Sans'; font-size: 1.2rem; color: white;
            box-shadow: 0 4px 0 rgba(0,0,0,0.5); transition: all 0.2s; opacity: 0.5; transform: scale(0.95);
        }
        .mode-btn.active { opacity: 1; transform: scale(1.1); box-shadow: 0 0 20px rgba(255,255,255,0.4); z-index: 10; border: 2px solid white; }
        .btn-investigate { background-color: #f1c40f; color: #333; }
        .btn-arrest { background-color: #e74c3c; }

        .toast {
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
            background: rgba(0,0,0,0.95); color: white; padding: 15px 30px;
            border-radius: 30px; font-size: 1.1rem; font-weight: bold; display: none; z-index: 500;
            border: 2px solid white; white-space: nowrap; box-shadow: 0 5px 15px rgba(0,0,0,0.5);
        }

        /* ëª¨ë‹¬ ìŠ¤íƒ€ì¼ */
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.9); display: flex; align-items: center; justify-content: center; z-index: 999; }
        .modal-content { background: #fff; color: #333; width: 90%; max-width: 400px; padding: 25px; border-radius: 15px; text-align: left; }
        .modal-header { font-family: 'Black Han Sans'; font-size: 1.6rem; margin-bottom: 15px; color: #2c3e50; text-align: center; border-bottom: 2px solid #eee; padding-bottom: 10px; }
        
        .tuto-step { display: none; }
        .tuto-step.active { display: block; animation: fadeIn 0.3s; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        .tuto-visual { background: #f0f0f0; border-radius: 10px; padding: 15px; margin: 15px 0; text-align: center; font-size: 2rem; font-weight: bold; border: 2px dashed #ccc; }
        .tuto-desc { font-size: 1.05rem; line-height: 1.6; color: #555; }
        .highlight { color: #e74c3c; font-weight: bold; background: #ffebee; padding: 0 4px; border-radius: 4px;}
        .highlight-blue { color: #2980b9; font-weight: bold; }

        .modal-footer { margin-top: 20px; display: flex; justify-content: space-between; align-items: center; }
        .btn-next { background: #2c3e50; color: white; padding: 10px 24px; border: none; border-radius: 8px; font-weight: bold; font-size: 1rem; }
        .btn-prev { background: #95a5a6; color: white; padding: 10px 20px; border: none; border-radius: 8px; font-weight: bold; }
        
        .go-msg { font-size: 1.3rem; text-align: center; margin: 20px 0; color: #c0392b; font-weight: bold; line-height: 1.4; }
        .btn-retry { width: 100%; padding: 15px; background: #e74c3c; color: white; border: none; border-radius: 10px; font-size: 1.2rem; font-family: 'Black Han Sans'; cursor: pointer; transition: transform 0.1s; }
        .btn-retry:active { transform: scale(0.98); }
        .win-header { color: #27ae60 !important; }
        .win-msg { color: #2ecc71 !important; font-size: 1.4rem; }
        .btn-win { background: #2ecc71 !important; box-shadow: 0 4px 0 #27ae60; }
        .btn-win:active { transform: translateY(4px); box-shadow: none; }
        .pc-hint { font-size: 0.8rem; color: #aaa; margin-top: 5px; }

    </style>
</head>
<body>

    <div id="tutorial-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">ğŸ•µï¸ ì‹ ì… ìˆ˜ì‚¬ê´€ ì—°ìˆ˜</div>
            
            <div class="tuto-step active" id="step-0">
                <div class="tuto-desc">ë°˜ê°‘ìŠµë‹ˆë‹¤, ìˆ˜ì‚¬ê´€ë‹˜!<br>ì•„íŒŒíŠ¸ ì£¼ë¯¼ë“¤ì´ ì¸µê°„ì†ŒìŒìœ¼ë¡œ ê³ í†µë°›ê³  ìˆìŠµë‹ˆë‹¤.<br>ì°½ë¬¸ì„ ì¡°ì‚¬í•´ì„œ ë²”ì¸ì„ ì°¾ì•„ì£¼ì„¸ìš”.</div>
                <div class="tuto-visual">ğŸ¢ ğŸ” ğŸ‘®</div>
                <div class="tuto-desc"><span class="highlight-blue">ì²« ë²ˆì§¸ í´ë¦­ì€ ë¬´ì¡°ê±´ ì•ˆì „í•©ë‹ˆë‹¤.</span><br>ì•„ë¬´ ì°½ë¬¸ì´ë‚˜ ëˆŒëŸ¬ì„œ ì‹œì‘í•˜ì„¸ìš”!</div>
            </div>

            <div class="tuto-step" id="step-1">
                <div class="tuto-desc">ë²”ì¸ì€ <b>[ì•„ë˜, ì™¼ìª½, ì˜¤ë¥¸ìª½]</b> ì§‘ì„ ê³µê²©í•©ë‹ˆë‹¤.<br>(ì†ŒìŒì€ ì•„ë˜ë¡œ ë‚´ë ¤ê°€ë‹ˆê¹Œìš”!)</div>
                <div class="tuto-visual">
                    ğŸ‘¹ <span style="font-size:1rem">â¡(5)</span> ğŸ˜ 
                </div>
                <div class="tuto-desc">
                    ë”°ë¼ì„œ <b>ë‚´ ì§‘ì´ ì‹œë„ëŸ½ë‹¤ë©´?</b><br>
                    ë²”ì¸ì€ <span class="highlight">ë‚´ ìœ„ì¸µì´ë‚˜ ì˜†ì§‘</span>ì— ìˆìŠµë‹ˆë‹¤!<br>
                    ë²”ì¸ì˜ ì§‘ì„ ì—­ì¶”ì í•˜ì„¸ìš”.
                </div>
            </div>

            <div class="tuto-step" id="step-2">
                <div class="tuto-desc">ì†ŒìŒì€ <b>ì¤‘ì²©(ë”í•˜ê¸°)</b>ë©ë‹ˆë‹¤!<br>ì´ê²Œ ê°€ì¥ ì¤‘ìš”í•œ ë‹¨ì„œì…ë‹ˆë‹¤.</div>
                <div class="tuto-visual">
                    5 + 5 = <span style="color:red">10</span> ğŸ”¥
                </div>
                <div class="tuto-desc">
                    ìˆ«ìê°€ <span class="highlight">5 ì´ìƒ</span>ì´ë‹¤? ğŸ‘‰ <b>ë°”ë¡œ ê·¼ì²˜(ìœ„/ì˜†)ì— ë²”ì¸ì´ ìˆë‹¤</b>ëŠ” ëœ»ì…ë‹ˆë‹¤.<br>ìˆ«ìê°€ 10 ì´ìƒì´ë©´ 2ëª…ì´ë‚˜ ë¶™ì–´ìˆëŠ” ê²ë‹ˆë‹¤!
                </div>
            </div>

            <div class="tuto-step" id="step-3">
                <div class="tuto-desc"><b>ğŸ¤ í°ìƒ‰ ì°½ë¬¸ì€ ì•ˆì „ì§€ëŒ€</b>ì…ë‹ˆë‹¤.<br>ì†ŒìŒì´ 0ì¸ ê³³ì€ ë§ˆìŒê» ëˆ„ë¥´ì„¸ìš”.</div>
                <div class="tuto-visual" style="background:white; border:2px solid #eee;">
                    ğŸ¤ ì•ˆì „ (0dB)
                </div>
                <div class="tuto-desc">
                    ë²”ì¸ì„ ì¡ìœ¼ë©´(ê²€ê±°),<br>ê·¸ ë²”ì¸ì˜ <b>ìƒí•˜ì¢Œìš°ëŠ” 100% ì•ˆì „</b>í•´ì§‘ë‹ˆë‹¤.<br>(ë²”ì¸ë¼ë¦¬ëŠ” ë¶™ì–´ì‚´ì§€ ì•Šê±°ë“ ìš”!)
                </div>
            </div>

            <div class="tuto-step" id="step-4">
                <div class="tuto-desc">ì, ì´ì œ ì¶œë™í•©ì‹œë‹¤!<br>í•˜ë‹¨ ë²„íŠ¼ìœ¼ë¡œ ëª¨ë“œë¥¼ ë³€ê²½í•˜ì„¸ìš”.</div>
                <div class="tuto-visual">
                    <span style="color:#f1c40f">ğŸ” ì¡°ì‚¬</span> vs <span style="color:#e74c3c">ğŸ‘® ê²€ê±°</span>
                </div>
                <div class="tuto-desc">
                    ì‹¤ìˆ˜ë¡œ <span class="highlight">ë²”ì¸</span>ì„ ì¡°ì‚¬í•˜ê±°ë‚˜ <span class="highlight">ì–µìš¸í•œ ì‹œë¯¼</span>ì„ ì¡ìœ¼ë©´<br>
                    <b>í•˜íŠ¸ê°€ ê¹ì…ë‹ˆë‹¤!</b> (ì¦‰ì‹œ ê²Œì„ì˜¤ë²„ ì•„ë‹˜)
                </div>
            </div>

            <div class="modal-footer">
                <button class="btn-prev" onclick="prevStep()">â—€ ì´ì „</button>
                <button class="btn-next" onclick="nextStep()">ë‹¤ìŒ â–¶</button>
            </div>
        </div>
    </div>

    <div id="game-over-modal" class="modal-overlay" style="display: none;">
        <div class="modal-content" style="text-align: center;">
            <div class="modal-header" id="go-title" style="color: #e74c3c;">ìˆ˜ì‚¬ ì‹¤íŒ¨</div>
            <div class="go-msg" id="go-message">ì²´ë ¥ì´ ëª¨ë‘ ì†Œì§„ë˜ì—ˆìŠµë‹ˆë‹¤... ğŸ˜­</div>
            <button class="btn-retry" onclick="retryGame()">ğŸ”„ ë‹¤ì‹œ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?</button>
        </div>
    </div>

    <div id="victory-modal" class="modal-overlay" style="display: none;">
        <div class="modal-content" style="text-align: center;">
            <div class="modal-header win-header">ğŸ‰ ìˆ˜ì‚¬ ì™„ë£Œ!</div>
            <div class="go-msg win-msg">ëª¨ë“  ë²”ì¸ì„ ê²€ê±°í–ˆìŠµë‹ˆë‹¤!<br>ì™„ë²½í•œ ìˆ˜ì‚¬ì…ë‹ˆë‹¤! ğŸ˜</div>
            <button class="btn-retry btn-win" onclick="retryGameVictory()">ğŸ† ë‹¤ì‹œ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?</button>
        </div>
    </div>

    <div class="ui-panel">
        <div class="header-row">
            <h1>ğŸ¢ ì¸µê°„ìˆ˜ì‚¬ëŒ€ M</h1>
            <button class="btn-restart-big" onclick="initGame()">ğŸ”„ ë‹¤ì‹œ ì‹œì‘</button>
        </div>
        <div class="difficulty-bar">
            <button class="btn-diff active" onclick="setDifficulty('easy', this)">ì´ˆê¸‰</button>
            <button class="btn-diff" onclick="setDifficulty('normal', this)">ì¤‘ê¸‰</button>
            <button class="btn-diff" onclick="setDifficulty('hard', this)">ê³ ê¸‰</button>
        </div>
        <div class="status-bar">
            <div id="lives">â¤ï¸â¤ï¸â¤ï¸</div>
            <div>ê²€ê±°: <span id="score" class="score-num">0</span> <span id="total-criminals">/ 5</span></div>
        </div>
    </div>

    <div class="game-container">
        <div class="building-container">
            <div class="roof"></div>
            <div id="game-board"></div>
        </div>
        <div class="pc-hint">(PC: ìš°í´ë¦­ = ì¦‰ì‹œ ê²€ê±°)</div>
    </div>

    <div class="controls">
        <button id="btn-mode-investigate" class="mode-btn btn-investigate active" onclick="setMode('investigate')">
            ğŸ” ì¡°ì‚¬í•˜ê¸°
        </button>
        <button id="btn-mode-arrest" class="mode-btn btn-arrest" onclick="setMode('arrest')">
            ğŸ‘® ê²€ê±°í•˜ê¸°
        </button>
    </div>

    <div id="toast" class="toast"></div>

    <script>
        let currentStep = 0;
        const totalSteps = 5;

        function updateTutorial() {
            for(let i=0; i<totalSteps; i++) { 
                const step = document.getElementById(`step-${i}`);
                if(step) step.classList.remove('active'); 
            }
            const current = document.getElementById(`step-${currentStep}`);
            if(current) current.classList.add('active');
            
            document.querySelector('.btn-prev').style.display = (currentStep === 0) ? 'none' : 'block';
            document.querySelector('.btn-next').innerText = (currentStep === totalSteps - 1) ? "ìˆ˜ì‚¬ ì‹œì‘! ğŸ˜" : "ë‹¤ìŒ â–¶";
        }

        function nextStep() { 
            if(currentStep < totalSteps - 1) { 
                currentStep++; 
                updateTutorial(); 
            } else { 
                document.getElementById('tutorial-modal').style.display = 'none'; 
            } 
        }

        function prevStep() { 
            if(currentStep > 0) { 
                currentStep--; 
                updateTutorial(); 
            } 
        }

        function showGameOver(msg) { 
            document.getElementById('go-message').innerText = msg; 
            document.getElementById('game-over-modal').style.display = 'flex'; 
        }

        function retryGame() { 
            document.getElementById('game-over-modal').style.display = 'none'; 
            initGame(); 
        }

        function showVictory() { 
            document.getElementById('victory-modal').style.display = 'flex'; 
        }

        function retryGameVictory() { 
            document.getElementById('victory-modal').style.display = 'none'; 
            initGame(); 
        }

        const DIFFICULTIES = { 
            easy: { rows: 6, cols: 5, criminals: 5 }, 
            normal: { rows: 8, cols: 6, criminals: 8 }, 
            hard: { rows: 10, cols: 8, criminals: 13 } 
        };
        let currentDiff = DIFFICULTIES.easy;
        let grid = []; let lives = 3; let caught = 0; let isFirstClick = true; let currentMode = 'investigate'; let gameOver = false;

        const board = document.getElementById('game-board');
        const livesEl = document.getElementById('lives');
        const scoreEl = document.getElementById('score');
        const totalEl = document.getElementById('total-criminals');
        const toast = document.getElementById('toast');

        function setDifficulty(level, btn) {
            document.querySelectorAll('.btn-diff').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            currentDiff = DIFFICULTIES[level];
            document.documentElement.style.setProperty('--cols', currentDiff.cols);
            let containerWidth = Math.min(window.innerWidth, 500) - 40;
            let size = containerWidth / currentDiff.cols;
            document.documentElement.style.setProperty('--cell-size', size + 'px');
            initGame();
        }

        window.addEventListener('resize', () => {
             let containerWidth = Math.min(window.innerWidth, 500) - 40;
             let size = containerWidth / currentDiff.cols;
             document.documentElement.style.setProperty('--cell-size', size + 'px');
        });

        function initGame() {
            grid = []; lives = 3; caught = 0; isFirstClick = true; gameOver = false;
            setMode('investigate'); updateUI();
            totalEl.innerText = "/ " + currentDiff.criminals;
            board.innerHTML = '';
            for(let r=0; r<currentDiff.rows; r++){
                for(let c=0; c<currentDiff.cols; c++){
                    let cell = document.createElement('div');
                    cell.className = 'window'; cell.dataset.r = r; cell.dataset.c = c;
                    cell.innerHTML = `<div class="noise-icon"></div><div class="val"></div>`;
                    cell.onclick = () => handleInput(r, c, cell, 'left');
                    cell.oncontextmenu = (e) => { e.preventDefault(); handleInput(r, c, cell, 'right'); };
                    board.appendChild(cell);
                }
            }
        }

        function setMode(mode) {
            currentMode = mode;
            document.getElementById('btn-mode-investigate').classList.toggle('active', mode === 'investigate');
            document.getElementById('btn-mode-arrest').classList.toggle('active', mode === 'arrest');
        }

        function generateMap(safeR, safeC) {
            grid = [];
            for(let r=0; r<currentDiff.rows; r++){
                let row = [];
                for(let c=0; c<currentDiff.cols; c++){
                    row.push({ isCriminal: false, noise: 0, revealed: false, checked: false, el: document.querySelector(`.window[data-r='${r}'][data-c='${c}']`) });
                }
                grid.push(row);
            }
            let placed = 0; let attempts = 0;
            while(placed < currentDiff.criminals && attempts < 2000) {
                attempts++;
                let r = Math.floor(Math.random() * currentDiff.rows); let c = Math.floor(Math.random() * currentDiff.cols);
                if(Math.abs(r - safeR) <= 1 && Math.abs(c - safeC) <= 1) continue;
                if(grid[r][c].isCriminal) continue;
                let tooClose = false;
                [[0,1],[0,-1],[1,0],[-1,0]].forEach(([dr, dc]) => {
                    let nr=r+dr, nc=c+dc;
                    if(nr>=0 && nr<currentDiff.rows && nc>=0 && nc<currentDiff.cols && grid[nr][nc].isCriminal) tooClose = true;
                });
                if(tooClose) continue;
                grid[r][c].isCriminal = true; placed++;
            }
            const dirs = [{dr:1, dc:0}, {dr:0, dc:-1}, {dr:0, dc:1}];
            for(let r=0; r<currentDiff.rows; r++){
                for(let c=0; c<currentDiff.cols; c++){
                    if(grid[r][c].isCriminal) {
                        dirs.forEach(d => { addNoise(r+d.dr, c+d.dc, 5); addNoise(r+d.dr*2, c+d.dc*2, 1); });
                    }
                }
            }
        }

        function addNoise(r, c, v) { if(r>=0 && r<currentDiff.rows && c>=0 && c<currentDiff.cols) grid[r][c].noise += v; }

        function handleInput(r, c, el, inputType) {
            if(gameOver) return;
            if(isFirstClick) {
                generateMap(r, c); isFirstClick = false; revealCell(r, c);
                if(inputType === 'right' || currentMode === 'arrest') { showToast("ì²« í´ë¦­ì€ ì•ˆì „ì§€ëŒ€ë¥¼ í™•ë³´í•©ë‹ˆë‹¤!", "#f39c12"); setMode('investigate'); }
                return;
            }
            let cell = grid[r][c];
            if(cell.revealed || cell.checked) return;
            let action = (inputType === 'right') ? 'arrest' : currentMode;

            if(action === 'investigate') {
                if(cell.isCriminal) {
                    // â­ ìˆ˜ì •: ì¡°ì‚¬ ëª¨ë“œì—ì„œ ë²”ì¸ í´ë¦­ ì‹œ lives ê¹ê³  caught ì¹´ìš´íŠ¸ ì˜¬ë¦¬ê¸°
                    lives--; 
                    caught++;
                    updateUI(); // ì ìˆ˜ì™€ í•˜íŠ¸ UI ì¦‰ì‹œ ë°˜ì˜
                    cell.checked = true; el.classList.add('busted'); openSafeNeighbors(r, c);
                    if(lives <= 0) { gameOver = true; showGameOver("ì²´ë ¥ì´ ëª¨ë‘ ì†Œì§„ë˜ì—ˆìŠµë‹ˆë‹¤... ğŸ’”"); }
                    else { showToast("ë²”ì¸ì—ê²Œ ë“¤ì¼°ìŠµë‹ˆë‹¤! (í•˜íŠ¸ -1)", "red"); if(caught === currentDiff.criminals) setTimeout(() => { gameOver = true; showVictory(); }, 500); }
                } else { revealCell(r, c); }
            } else {
                if(cell.isCriminal) {
                    cell.checked = true; el.classList.add('arrested'); el.querySelector('.noise-icon').innerText = "ğŸ‘®â€â™‚ï¸"; caught++; updateUI(); openSafeNeighbors(r, c);
                    if(caught === currentDiff.criminals) { gameOver = true; showVictory(); } else { showToast("ê²€ê±° ì„±ê³µ!", "#3498db"); }
                } else {
                    lives--; updateUI(); el.classList.add('angry'); el.querySelector('.noise-icon').innerText = "ğŸ¤¬";
                    showToast(`ì–µìš¸í•´ìš”! (${cell.noise}dB)`, "red");
                    setTimeout(() => { el.classList.remove('angry'); revealCell(r, c); }, 600);
                    if(lives <= 0) { gameOver = true; showGameOver("ë¯¼ì› í­ì£¼ë¡œ í•´ê³ ë˜ì—ˆìŠµë‹ˆë‹¤... ğŸ’”"); }
                }
            }
        }

        function revealCell(r, c, safeBonus = false) {
            let cell = grid[r][c]; if(cell.revealed) return;
            cell.revealed = true; cell.el.classList.add('revealed');
            if(safeBonus) cell.el.classList.add('safe-open');
            if(cell.noise > 0) {
                let level = 1; let icon = "ğŸ”ˆ";
                if(cell.noise >= 10) { level = 3; icon = "ğŸ”¥"; } else if(cell.noise >= 5) { level = 2; icon = "ğŸ”Š"; }
                cell.el.classList.add(`level-${level}`); cell.el.querySelector('.val').innerText = cell.noise; cell.el.querySelector('.noise-icon').innerText = icon;
            } else {
                cell.el.classList.add('safe'); cell.el.querySelector('.noise-icon').innerText = "ğŸ¤"; floodFill(r, c);
            }
        }

        function floodFill(r, c) {
            [[0,1],[0,-1],[1,0],[-1,0], [1,1],[1,-1],[-1,1],[-1,-1]].forEach(([dr, dc]) => {
                let nr=r+dr, nc=c+dc;
                if(nr>=0 && nr<currentDiff.rows && nc>=0 && nc<currentDiff.cols && !grid[nr][nc].isCriminal && !grid[nr][nc].revealed) {
                    if(grid[nr][nc].noise === 0) revealCell(nr, nc); else revealCell(nr, nc);
                }
            });
        }

        function openSafeNeighbors(r, c) {
            [[0,1],[0,-1],[1,0],[-1,0]].forEach(([dr, dc]) => {
                let nr=r+dr, nc=c+dc;
                if(nr>=0 && nr<currentDiff.rows && nc>=0 && nc<currentDiff.cols && !grid[nr][nc].revealed && !grid[nr][nc].checked) { revealCell(nr, nc, true); }
            });
        }

        function updateUI() {
            let h = ""; for(let i=0; i<3; i++) h += (i < lives ? "â¤ï¸" : "ğŸ’”"); livesEl.innerHTML = h; scoreEl.innerText = caught;
        }

        function showToast(msg, color) {
            toast.innerText = msg; toast.style.display = "block"; toast.style.borderColor = color;
            setTimeout(() => toast.style.display = "none", 1500);
        }

        setDifficulty('easy', document.querySelector('.btn-diff.active'));
        updateTutorial(); 
    </script>
</body>
</html>
