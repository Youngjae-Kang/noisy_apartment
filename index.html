<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ì¸µê°„ìˆ˜ì‚¬ëŒ€ M : ì‹¬ì—°</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Black+Han+Sans&family=Noto+Sans+KR:wght@400;700&display=swap');

        :root {
            --cell-size: 40px;
            --cols: 5;
            --bg-color: #2c3e50;
            --ui-bg: rgba(0,0,0,0.8);
        }

        body {
            font-family: 'Noto Sans KR', sans-serif;
            background-color: var(--bg-color);
            color: white;
            text-align: center;
            margin: 0; padding: 0;
            display: flex; flex-direction: column; align-items: center;
            height: 100vh; height: 100dvh; /* ì£¼ì†Œì°½ ì œì™¸í•œ ì‹¤ì œ ë†’ì´ */
            user-select: none; touch-action: manipulation; 
            overflow: hidden; /* ì „ì²´ ìŠ¤í¬ë¡¤ ê¸ˆì§€ */
        }

        /* ìƒë‹¨ UI íŒ¨ë„ */
        .ui-panel {
            width: 100%; background: var(--ui-bg); padding: 10px 0;
            box-shadow: 0 5px 20px rgba(0,0,0,0.5); border-bottom: 2px solid #34495e;
            z-index: 100; backdrop-filter: blur(5px);
            flex-shrink: 0;
        }

        .header-row { display: flex; justify-content: center; align-items: center; gap: 15px; margin-bottom: 5px; }
        h1 { font-family: 'Black Han Sans', sans-serif; color: #f1c40f; font-size: 1.4rem; margin: 0; text-shadow: 2px 2px 0 #000; }

        .btn-restart-big {
            background: #e74c3c; color: white; border: none; border-radius: 8px;
            padding: 5px 12px; font-family: 'Black Han Sans'; font-size: 0.9rem;
            cursor: pointer; box-shadow: 0 3px 0 #c0392b;
        }
        .btn-restart-big:active { transform: translateY(2px); box-shadow: none; }

        .difficulty-bar { display: flex; justify-content: center; gap: 4px; margin-bottom: 5px; flex-wrap: wrap; }
        .btn-diff {
            background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.3);
            color: #ccc; padding: 4px 8px; border-radius: 15px; font-size: 0.7rem; cursor: pointer;
        }
        .btn-diff.active { background: #f1c40f; color: #2c3e50; font-weight: bold; border-color: #f1c40f; }
        .btn-diff.abyss { border-color: #ff0000; color: #ff9999; }
        .btn-diff.abyss.active { background: #ff0000; color: #fff; box-shadow: 0 0 10px #ff0000; }

        .status-bar { display: flex; justify-content: center; gap: 15px; font-size: 0.9rem; font-weight: bold; }
        .score-num { color: #2ecc71; font-size: 1.1rem; }

        /* ê²Œì„ ì˜ì—­: ì—¬ê¸°ê°€ í•µì‹¬ */
        .game-container {
            flex-grow: 1; 
            display: flex; flex-direction: column;
            align-items: center; justify-content: center; /* ì„¸ë¡œ ì¤‘ì•™ ì •ë ¬ */
            width: 100%; height: 100%;
            overflow: hidden;
            padding: 10px; box-sizing: border-box;
        }

        .building-container {
            background-color: #34495e; padding: 10px; border-radius: 8px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.6); border: 4px solid #1a252f; 
            position: relative; transition: all 0.3s ease;
        }
        .roof { position: absolute; top: -12px; left: -4px; right: -4px; height: 12px; background-color: #1a1a1a; border-radius: 5px 5px 0 0; }

        #game-board { 
            display: grid; 
            grid-template-columns: repeat(var(--cols), var(--cell-size)); 
            gap: 4px; /* ê°„ê²© ì‚´ì§ ì¤„ì„ */
        }

        .window {
            width: var(--cell-size); height: var(--cell-size);
            background-color: #111; border: 2px solid #000; border-bottom-width: 3px; border-radius: 4px;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            font-size: calc(var(--cell-size) * 0.45); font-weight: bold; 
            cursor: pointer; position: relative;
        }
        .window.revealed { cursor: default; }
        .window.revealed.safe { background-color: #f5f6fa; border-color: #dcdde1; }
        .window.revealed.level-1 { background-color: #fff9c4; color: #fbc02d; border-color: #fbc02d; }
        .window.revealed.level-2 { background-color: #ffcc80; color: #e65100; border-color: #fb8c00; }
        .window.revealed.level-3 { background-color: #ef9a9a; color: #b71c1c; border-color: #c62828; animation: pulse-red 1.5s infinite; }
        
        @keyframes pulse-red { 0%, 100% { box-shadow: inset 0 0 5px #e57373; } 50% { box-shadow: inset 0 0 15px #e57373; } }

        .noise-icon { font-size: 0.8em; }
        .window.arrested { background-color: #2980b9 !important; color: white !important; }
        .window.arrested .noise-icon { content: "ğŸ‘®â€â™‚ï¸"; font-size: 1.3em; }
        .window.busted { background-color: #c0392b !important; color: white !important; }

        /* í•˜ë‹¨ ì»¨íŠ¸ë¡¤ */
        .controls {
            width: 100%; background: var(--ui-bg);
            display: flex; justify-content: center; gap: 10px; 
            padding: 15px 0; flex-shrink: 0;
            border-top: 1px solid rgba(255,255,255,0.1);
        }
        .mode-btn {
            padding: 10px 20px; border-radius: 25px; border: none;
            font-family: 'Black Han Sans'; font-size: 1rem; color: white;
            box-shadow: 0 4px 0 rgba(0,0,0,0.3); opacity: 0.6;
        }
        .mode-btn.active { opacity: 1; transform: scale(1.05); border: 2px solid white; }
        .btn-investigate { background-color: #f1c40f; color: #333; }
        .btn-arrest { background-color: #e74c3c; }

        .toast {
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
            background: rgba(0,0,0,0.9); color: white; padding: 10px 20px;
            border-radius: 20px; font-size: 0.9rem; display: none; z-index: 500;
            border: 1px solid white;
        }

        /* ëª¨ë‹¬ ìŠ¤íƒ€ì¼ (ë‚´ìš©ì´ ê¸¸ë©´ ëª¨ë‹¬ ë‚´ë¶€ë§Œ ìŠ¤í¬ë¡¤) */
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.9); display: flex; align-items: center; justify-content: center; z-index: 999; }
        .modal-content { background: #fff; color: #333; width: 85%; max-width: 350px; padding: 20px; border-radius: 15px; max-height: 80vh; overflow-y: auto; }
        .modal-header { font-family: 'Black Han Sans'; font-size: 1.4rem; color: #2c3e50; border-bottom: 2px solid #eee; margin-bottom: 10px; }
        .tuto-step { display: none; }
        .tuto-step.active { display: block; }
        .tuto-visual { background: #f0f0f0; border-radius: 10px; padding: 10px; margin: 10px 0; font-size: 1.5rem; text-align: center; }
        .tuto-desc { font-size: 0.9rem; line-height: 1.5; text-align: left; }
        .btn-next { background: #2c3e50; color: white; padding: 8px 16px; border: none; border-radius: 5px; cursor: pointer; }
    </style>
</head>
<body>

    <div id="tutorial-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">ğŸ¹ í–„ìŠ¤í„° ìš”ì› ë¸Œë¦¬í•‘ ğŸ¾</div>
            <div class="tuto-step active" id="step-0">
                <div class="tuto-desc">ì°! ë°˜ê°‘ìŠµë‹ˆë‹¤. ì•„íŒŒíŠ¸ë¥¼ ë’¤í”ë“œëŠ” ì¸µê°„ì†ŒìŒ ì£¼ë²”ì„ ì°¾ìœ¼ì„¸ìš”!</div>
                <div class="tuto-visual">ğŸ¢ ğŸ” ğŸ‘®</div>
                <div class="tuto-desc"><b>ì²« ë²ˆì§¸ í´ë¦­ì€ ë¬´ì¡°ê±´ ì•ˆì „í•©ë‹ˆë‹¤.</b> ì•„ë¬´ ê³³ì´ë‚˜ ëˆŒëŸ¬ì„œ ìˆ˜ì‚¬ë¥¼ ì‹œì‘í•˜ì„¸ìš”!</div>
            </div>
            <div class="tuto-step" id="step-1">
                <div class="tuto-desc">ì†ŒìŒì€ ìœ„ì—ì„œ ì•„ë˜/ì˜†ìœ¼ë¡œ íë¦…ë‹ˆë‹¤.</div>
                <div class="tuto-visual">ğŸ‘¹ â¡(5)â¡ ğŸ˜¡ â¡(1)â¡ ğŸ˜ </div>
                <div class="tuto-desc">ìˆ«ìë¥¼ ë³´ê³  ë²”ì¸ì˜ ìœ„ì¹˜ë¥¼ ì—­ì¶”ì í•˜ì„¸ìš”!</div>
            </div>
            <div style="margin-top: 15px; display: flex; justify-content: flex-end;">
                <button class="btn-next" onclick="nextStep()">ë‹¤ìŒ â–¶</button>
            </div>
        </div>
    </div>

    <div class="ui-panel" id="header">
        <div class="header-row">
            <h1>ğŸ¢ ì¸µê°„ìˆ˜ì‚¬ëŒ€ M</h1>
            <button class="btn-restart-big" onclick="initGame()">ğŸ”„ ì¬ì‹œì‘</button>
        </div>
        <div class="difficulty-bar">
            <button class="btn-diff active" onclick="setDifficulty('easy', this)">ì´ˆê¸‰</button>
            <button class="btn-diff" onclick="setDifficulty('normal', this)">ì¤‘ê¸‰</button>
            <button class="btn-diff" onclick="setDifficulty('hard', this)">ê³ ê¸‰</button>
            <button class="btn-diff" onclick="setDifficulty('master', this)">ìµœê³ ê¸‰</button>
            <button class="btn-diff abyss" onclick="setDifficulty('abyss', this)">ğŸ’€ì‹¬ì—°</button>
        </div>
        <div class="status-bar">
            <div id="lives">â¤ï¸â¤ï¸â¤ï¸</div>
            <div>ê²€ê±°: <span id="score" class="score-num">0</span> <span id="total-criminals">/ 5</span></div>
        </div>
    </div>

    <div class="game-container">
        <div class="building-container">
            <div class="roof"></div>
            <div id="game-board"></div>
        </div>
    </div>

    <div class="controls" id="footer">
        <button id="btn-mode-investigate" class="mode-btn btn-investigate active" onclick="setMode('investigate')">ğŸ” ì¡°ì‚¬</button>
        <button id="btn-mode-arrest" class="mode-btn btn-arrest" onclick="setMode('arrest')">ğŸ‘® ê²€ê±°</button>
    </div>

    <div id="toast" class="toast"></div>

    <script>
        let currentStep = 0;
        function nextStep() {
            document.getElementById(`step-${currentStep}`).classList.remove('active');
            currentStep++;
            if(currentStep > 1) document.getElementById('tutorial-modal').style.display = 'none';
            else document.getElementById(`step-${currentStep}`).classList.add('active');
        }

        const DIFFICULTIES = { 
            easy: { rows: 6, cols: 5, criminals: 5 }, 
            normal: { rows: 8, cols: 6, criminals: 8 }, 
            hard: { rows: 10, cols: 8, criminals: 13 },
            master: { rows: 12, cols: 10, criminals: 20 },
            abyss: { rows: 15, cols: 12, criminals: 40 } 
        };
        
        let currentDiff = DIFFICULTIES.easy;
        let grid = [], lives = 3, caught = 0, isFirstClick = true, currentMode = 'investigate', gameOver = false;

        const board = document.getElementById('game-board');
        const scoreEl = document.getElementById('score');
        const totalEl = document.getElementById('total-criminals');

        // â­ í™”ë©´ í¬ê¸°ì— ë§ê²Œ ê²©ì ì‚¬ì´ì¦ˆ ê³„ì‚°í•˜ëŠ” í•µì‹¬ í•¨ìˆ˜
        function resizeGame() {
            const headerH = document.getElementById('header').offsetHeight;
            const footerH = document.getElementById('footer').offsetHeight;
            const padding = 40; // ì—¬ìœ  ê³µê°„
            
            const availableW = window.innerWidth - padding;
            const availableH = window.innerHeight - headerH - footerH - padding;
            
            const sizeByW = availableW / currentDiff.cols;
            const sizeByH = availableH / currentDiff.rows;
            
            // ê°€ë¡œ/ì„¸ë¡œ ì¤‘ ë” ê½‰ ì°¨ëŠ” ìª½ì— ë§ì¶¤ (ìµœëŒ€ 60px ì œí•œ)
            const finalSize = Math.min(sizeByW, sizeByH, 60);
            
            document.documentElement.style.setProperty('--cell-size', finalSize + 'px');
            document.documentElement.style.setProperty('--cols', currentDiff.cols);
        }

        window.addEventListener('resize', resizeGame);

        function setDifficulty(level, btn) {
            document.querySelectorAll('.btn-diff').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            currentDiff = DIFFICULTIES[level];
            resizeGame();
            initGame();
        }

        function initGame() {
            grid = []; lives = 3; caught = 0; isFirstClick = true; gameOver = false;
            setMode('investigate'); updateUI();
            totalEl.innerText = "/ " + currentDiff.criminals;
            board.innerHTML = '';
            for(let r=0; r<currentDiff.rows; r++){
                for(let c=0; c<currentDiff.cols; c++){
                    let cell = document.createElement('div');
                    cell.className = 'window'; cell.dataset.r = r; cell.dataset.c = c;
                    cell.innerHTML = `<div class="noise-icon"></div><div class="val"></div>`;
                    cell.onclick = () => handleInput(r, c, cell, 'left');
                    cell.oncontextmenu = (e) => { e.preventDefault(); handleInput(r, c, cell, 'right'); };
                    board.appendChild(cell);
                }
            }
        }

        function setMode(mode) {
            currentMode = mode;
            document.getElementById('btn-mode-investigate').classList.toggle('active', mode === 'investigate');
            document.getElementById('btn-mode-arrest').classList.toggle('active', mode === 'arrest');
        }

        function generateMap(safeR, safeC) {
            grid = [];
            for(let r=0; r<currentDiff.rows; r++){
                let row = [];
                for(let c=0; c<currentDiff.cols; c++) row.push({ isCriminal: false, noise: 0, revealed: false, checked: false, el: document.querySelector(`.window[data-r='${r}'][data-c='${c}']`) });
                grid.push(row);
            }
            let placed = 0;
            while(placed < currentDiff.criminals) {
                let r = Math.floor(Math.random() * currentDiff.rows), c = Math.floor(Math.random() * currentDiff.cols);
                if(Math.abs(r-safeR)<=1 && Math.abs(c-safeC)<=1) continue;
                if(grid[r][c].isCriminal) continue;
                let tooClose = false;
                [[0,1],[0,-1],[1,0],[-1,0]].forEach(([dr, dc]) => {
                    let nr=r+dr, nc=c+dc;
                    if(nr>=0 && nr<currentDiff.rows && nc>=0 && nc<currentDiff.cols && grid[nr][nc].isCriminal) tooClose = true;
                });
                if(tooClose) continue;
                grid[r][c].isCriminal = true; placed++;
            }
            const dirs = [{dr:1, dc:0}, {dr:0, dc:-1}, {dr:0, dc:1}];
            for(let r=0; r<currentDiff.rows; r++)
                for(let c=0; c<currentDiff.cols; c++)
                    if(grid[r][c].isCriminal) dirs.forEach(d => { addNoise(r+d.dr, c+d.dc, 5); addNoise(r+d.dr*2, c+d.dc*2, 1); });
        }

        function addNoise(r, c, v) { if(r>=0 && r<currentDiff.rows && c>=0 && c<currentDiff.cols) grid[r][c].noise += v; }

        function handleInput(r, c, el, inputType) {
            if(gameOver) return;
            if(isFirstClick) { generateMap(r, c); isFirstClick = false; revealCell(r, c); return; }
            let cell = grid[r][c]; if(cell.revealed || cell.checked) return;
            let action = (inputType === 'right') ? 'arrest' : currentMode;

            if(action === 'investigate') {
                if(cell.isCriminal) {
                    lives--; caught++; updateUI(); cell.checked = true; el.classList.add('busted'); openSafeNeighbors(r, c);
                    if(lives <= 0) { gameOver = true; alert("ìˆ˜ì‚¬ ì‹¤íŒ¨! ğŸ˜­"); }
                    else if(caught === currentDiff.criminals) setTimeout(() => alert("ì˜¬ê²€ê±° ì„±ê³µ! ğŸ˜"), 300);
                } else revealCell(r, c);
            } else {
                if(cell.isCriminal) {
                    cell.checked = true; el.classList.add('arrested'); caught++; updateUI(); openSafeNeighbors(r, c);
                    if(caught === currentDiff.criminals) alert("ì˜¬ê²€ê±° ì„±ê³µ! ğŸ˜");
                } else { lives--; updateUI(); el.classList.add('angry'); setTimeout(()=>el.classList.remove('angry'), 500); if(lives <= 0) alert("í•´ê³ ë˜ì—ˆìŠµë‹ˆë‹¤! ğŸ’”"); }
            }
        }

        function revealCell(r, c, safeBonus = false) {
            let cell = grid[r][c]; if(cell.revealed) return;
            cell.revealed = true; cell.el.classList.add('revealed');
            if(cell.noise > 0) {
                let lv = cell.noise >= 10 ? 3 : (cell.noise >= 5 ? 2 : 1);
                cell.el.classList.add(`level-${lv}`); cell.el.querySelector('.val').innerText = cell.noise;
                cell.el.querySelector('.noise-icon').innerText = ["ğŸ”ˆ", "ğŸ”Š", "ğŸ”¥"][lv-1];
            } else { cell.el.classList.add('safe'); cell.el.querySelector('.noise-icon').innerText = "ğŸ¤"; floodFill(r, c); }
        }

        function floodFill(r, c) {
            [[0,1],[0,-1],[1,0],[-1,0], [1,1],[1,-1],[-1,1],[-1,-1]].forEach(([dr, dc]) => {
                let nr=r+dr, nc=c+dc;
                if(nr>=0 && nr<currentDiff.rows && nc>=0 && nc<currentDiff.cols && !grid[nr][nc].isCriminal && !grid[nr][nc].revealed) revealCell(nr, nc);
            });
        }

        function openSafeNeighbors(r, c) {
            [[0,1],[0,-1],[1,0],[-1,0]].forEach(([dr, dc]) => {
                let nr=r+dr, nc=c+dc;
                if(nr>=0 && nr<currentDiff.rows && nc>=0 && nc<currentDiff.cols && !grid[nr][nc].revealed && !grid[nr][nc].checked) revealCell(nr, nc, true);
            });
        }

        function updateUI() {
            let h = ""; for(let i=0; i<3; i++) h += (i < lives ? "â¤ï¸" : "ğŸ’”");
            document.getElementById('lives').innerHTML = h; scoreEl.innerText = caught;
        }

        resizeGame();
        initGame();
    </script>
</body>
</html>
