<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ì¸µê°„ìˆ˜ì‚¬ëŒ€ M : ì •ë°€ìˆ˜ì‚¬</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Black+Han+Sans&family=Noto+Sans+KR:wght@400;700&display=swap');

        :root {
            --cell-size: 50px;
            --cols: 5;
            --bg-color: #2c3e50;
            --ui-bg: rgba(0,0,0,0.8);
        }

        body {
            font-family: 'Noto Sans KR', sans-serif;
            background-color: var(--bg-color);
            color: white;
            text-align: center;
            margin: 0; padding: 0;
            display: flex; flex-direction: column; align-items: center;
            min-height: 100vh;
            user-select: none; touch-action: manipulation;
            overflow-x: hidden;
            overflow-y: auto;
        }

        .ui-panel {
            width: 100%; background: var(--ui-bg); padding: 15px 0;
            box-shadow: 0 5px 20px rgba(0,0,0,0.5); border-bottom: 2px solid #34495e;
            position: fixed; top: 0; z-index: 100; backdrop-filter: blur(5px);
        }

        .header-row { display: flex; justify-content: center; align-items: center; gap: 15px; margin-bottom: 10px; }
        h1 { font-family: 'Black Han Sans', sans-serif; color: #f1c40f; font-size: 1.6rem; margin: 0; text-shadow: 2px 2px 0 #000; }

        .btn-restart-big {
            background: #e74c3c; color: white; border: none; border-radius: 8px;
            padding: 8px 16px; font-family: 'Black Han Sans'; font-size: 1rem;
            cursor: pointer; box-shadow: 0 4px 0 #c0392b; transition: transform 0.1s;
        }
        .btn-restart-big:active { transform: translateY(4px); box-shadow: none; }

        .difficulty-bar { display: flex; justify-content: center; gap: 4px; margin-bottom: 8px; flex-wrap: wrap; padding: 0 5px; }
        .btn-diff {
            background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.3);
            color: #ccc; padding: 6px 8px; border-radius: 20px; font-size: 0.7rem; cursor: pointer;
        }
        .btn-diff.active { background: #f1c40f; color: #2c3e50; font-weight: bold; border-color: #f1c40f; }
        .btn-diff.master { border-color: #9b59b6; color: #d7bde2; }
        .btn-diff.master.active { background: #9b59b6; color: #fff; border-color: #8e44ad; }
        .btn-diff.abyss { border-color: #ff0000; color: #ff9999; }
        .btn-diff.abyss.active { background: #000; color: #ff0000; border-color: #ff0000; box-shadow: 0 0 15px #ff0000; animation: blink-red 1s infinite; }
        @keyframes blink-red { 0%, 100% { opacity: 1; } 50% { opacity: 0.7; } }
        .btn-diff.abyss2 { border-color: #581845; color: #c70039; font-weight: 900; }
        .btn-diff.abyss2.active { background: #581845; color: #ffc300; border-color: #ff5733; box-shadow: 0 0 20px #c70039; animation: pulse-purple 1.5s infinite; }
        @keyframes pulse-purple { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }
        .btn-diff.empty-mode { border-color: #95a5a6; color: #bdc3c7; }
        .btn-diff.empty-mode.active { background: #7f8c8d; color: #fff; border-color: #bdc3c7; box-shadow: 0 0 10px #7f8c8d; }
        .btn-diff.heatmap-mode { border-color: #e67e22; color: #f39c12; }
        .btn-diff.heatmap-mode.active { background: #e67e22; color: #fff; border-color: #fff; box-shadow: 0 0 10px #e67e22; }

        .status-bar { display: flex; justify-content: center; gap: 20px; font-size: 1rem; font-weight: bold; }
        .score-num { color: #2ecc71; font-size: 1.3rem; }

        .game-container {
            margin-top: 180px; margin-bottom: 120px;
            flex-grow: 1; display: flex; flex-direction: column;
            align-items: center; justify-content: center; width: 100%; 
            padding: 10px; box-sizing: border-box;
        }

        .building-container {
            background-color: #34495e; padding: 15px; border-radius: 8px;
            box-shadow: 0 15px 40px rgba(0,0,0,0.6); border: 4px solid #1a252f; position: relative;
        }
        .roof { position: absolute; top: -15px; left: -5px; right: -5px; height: 15px; background-color: #1a1a1a; border-radius: 5px 5px 0 0; }

        #game-board { display: grid; grid-template-columns: repeat(var(--cols), var(--cell-size)); gap: 5px; }

        .window {
            width: var(--cell-size); height: var(--cell-size);
            background-color: #111; border: 2px solid #000; border-bottom-width: 4px; border-radius: 4px;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            font-size: calc(var(--cell-size) * 0.45); font-weight: bold; 
            cursor: pointer; position: relative; transition: transform 0.1s;
        }
        .window:active { transform: scale(0.95); }
        .window.revealed { cursor: default; }
        .window.revealed.safe { background-color: #f5f6fa; border-color: #dcdde1; box-shadow: none; }
        .window.revealed.empty-house { background-color: #7f8c8d; border-color: #2c3e50; color: #2c3e50; opacity: 0.7; }

        /* íˆíŠ¸ë§µ ì „ìš© ìƒ‰ìƒ */
        .window.revealed.h-0 { background-color: #2980b9 !important; border-color: #1c5982; }
        .window.revealed.h-1 { background-color: #f1c40f !important; border-color: #c29d0b; }
        .window.revealed.h-2 { background-color: #e67e22 !important; border-color: #b35f15; }
        .window.revealed.h-3 { background-color: #c0392b !important; border-color: #912b20; animation: pulse-red 1.5s infinite; }

        .window.revealed.level-1 { background-color: #fff9c4; color: #fbc02d; border-color: #fbc02d; box-shadow: inset 0 0 10px #fff176; }
        .window.revealed.level-2 { background-color: #ffcc80; color: #e65100; border-color: #fb8c00; box-shadow: inset 0 0 10px #ffb74d; font-weight: 900; }
        .window.revealed.level-3 { background-color: #ef9a9a; color: #b71c1c; border-color: #c62828; box-shadow: inset 0 0 15px #e57373; animation: pulse-red 1.5s infinite; }
        @keyframes pulse-red { 0% { box-shadow: inset 0 0 5px #e57373; } 50% { box-shadow: inset 0 0 20px #e57373; } 100% { box-shadow: inset 0 0 5px #e57373; } }

        .noise-icon { font-size: 0.8em; margin-bottom: 2px; }
        .window.arrested { background-color: #2c3e50 !important; color: white !important; border-color: #3498db; }
        .window.arrested .noise-icon { content: "ğŸ‘®â€â™‚ï¸"; font-size: 1.5em; }
        .window.angry { background-color: #e74c3c !important; color: white !important; animation: shake 0.4s; }
        .window.busted { background-color: #c0392b !important; color: white !important; border-color: #e74c3c; animation: shake 0.4s; }
        .window.busted .noise-icon { content: "ğŸ‘¹"; font-size: 1.5em; }
        @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-5px); } 75% { transform: translateX(5px); } }
        .window.safe-open { animation: flashSafe 0.5s; background-color: #dff9fb; }
        @keyframes flashSafe { 0% { background-color: #2980b9; } 100% { background-color: #dff9fb; } }

        .controls {
            position: fixed; bottom: 0; left: 0; right: 0;
            display: flex; justify-content: center; gap: 15px; z-index: 100;
            padding-bottom: 20px; padding-top: 20px;
            background: linear-gradient(to top, rgba(44, 62, 80, 1) 40%, rgba(44, 62, 80, 0));
        }
        .mode-btn {
            padding: 14px 28px; border-radius: 35px; border: none;
            font-family: 'Black Han Sans'; font-size: 1.2rem; color: white;
            box-shadow: 0 4px 0 rgba(0,0,0,0.5); transition: all 0.2s; opacity: 0.5; transform: scale(0.95);
        }
        .mode-btn.active { opacity: 1; transform: scale(1.1); box-shadow: 0 0 20px rgba(255,255,255,0.4); z-index: 10; border: 2px solid white; }
        .btn-investigate { background-color: #f1c40f; color: #333; }
        .btn-arrest { background-color: #e74c3c; }

        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.9); display: flex; align-items: center; justify-content: center; z-index: 999; }
        .modal-content { background: #fff; color: #333; width: 90%; max-width: 400px; padding: 25px; border-radius: 20px; text-align: center; max-height: 85vh; overflow-y: auto; }
        .intro-header { margin-bottom: 20px; }
        .intro-title { font-family: 'Black Han Sans', sans-serif; font-size: 2rem; color: #f1c40f; text-shadow: 2px 2px 4px rgba(0,0,0,0.3); margin-bottom: 5px; }
        .intro-subtitle { font-size: 1.1rem; color: #7f8c8d; font-weight: bold; }
        .hamster-hero { font-size: 6rem; margin: 20px 0; animation: bounce 2s infinite; }
        @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-15px); } }

        .tuto-step { display: none; text-align: left; }
        .tuto-step.active { display: block; animation: fadeIn 0.3s; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .tuto-visual { background: #f0f0f0; border-radius: 10px; padding: 15px; margin: 15px 0; text-align: center; font-size: 2rem; font-weight: bold; border: 2px dashed #ccc; }
        .tuto-desc { font-size: 1.05rem; line-height: 1.6; color: #555; }
        .highlight { color: #e74c3c; font-weight: bold; background: #ffebee; padding: 0 4px; border-radius: 4px;}
        .highlight-blue { color: #2980b9; font-weight: bold; }

        .modal-footer { margin-top: 20px; display: flex; justify-content: space-between; align-items: center; }
        .btn-next { background: #2c3e50; color: white; padding: 10px 24px; border: none; border-radius: 8px; font-weight: bold; font-size: 1rem; }
        .btn-prev { background: #95a5a6; color: white; padding: 10px 20px; border: none; border-radius: 8px; font-weight: bold; }
    </style>
</head>
<body>

    <div id="tutorial-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="intro-header">
                <div class="intro-title">ì‘ì „ëª…: ë°°ê´€ ì ì…</div>
                <div class="intro-subtitle">ğŸ¹ ì‹ ì… í–„ìŠ¤í„° ìš”ì› ì—°ìˆ˜ ğŸ¾</div>
            </div>
            <div class="hamster-hero">ğŸ¹ğŸ”ğŸ¢</div>
            <div class="tuto-step active" id="step-0">
                <div class="tuto-desc">ì°! ë°˜ê°‘ìŠµë‹ˆë‹¤, ìš”ì›ë‹˜! ğŸ¹<br>ì¸ê°„ë“¤ì€ ëª¸ì´ ì»¤ì„œ ì´ ì¢ì€ ë°°ê´€ì„ í†µê³¼í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.<br><b>ë°°ê´€ì„ íƒ€ê³  ëª°ë˜ ì´ë™</b>í•´ì„œ, ì¸µê°„ì†ŒìŒì˜ ì£¼ë²”ì„ ì°¾ì•„ì£¼ì„¸ìš”!</div>
                <div class="tuto-visual">ğŸ¤« ğŸ¾ ì ì… ì‹œì‘! ğŸ”</div>
                <div class="tuto-desc"><span class="highlight-blue">ì²« ë²ˆì§¸ í´ë¦­ì€ ë¬´ì¡°ê±´ ì•ˆì „í•©ë‹ˆë‹¤.</span><br>ì•„ë¬´ ë°°ê´€(ì°½ë¬¸)ì´ë‚˜ ëˆŒëŸ¬ì„œ ì§„ì…í•˜ì„¸ìš”!</div>
            </div>
            <div class="tuto-step" id="step-1">
                <div class="tuto-desc">ë²”ì¸ì€ <b>[ì•„ë˜, ì™¼ìª½, ì˜¤ë¥¸ìª½]</b> ì§‘ìœ¼ë¡œ ì†ŒìŒì„ ëƒ…ë‹ˆë‹¤.<br>ê±°ë¦¬ì— ë”°ë¼ ì†ŒìŒ í¬ê¸°ê°€ ë‹¬ë¼ìš”!</div>
                <div class="tuto-visual">ğŸ‘¹ â¡(5)â¡ ğŸ˜¡ â¡(1)â¡ ğŸ˜ </div>
                <div class="tuto-desc">ğŸ”´ <b>ì†ŒìŒ 5:</b> ë°”ë¡œ ì˜†ì§‘ (1ì¹¸ ê±°ë¦¬)<br>ğŸŸ¡ <b>ì†ŒìŒ 1:</b> ê±´ë„ˆí¸ ì§‘ (2ì¹¸ ê±°ë¦¬)</div>
            </div>
            <div class="tuto-step" id="step-2">
                <div class="tuto-desc">ì†ŒìŒì€ <b>ì¤‘ì²©(ë”í•˜ê¸°)</b>ë©ë‹ˆë‹¤!<br>ì´ê²Œ ê°€ì¥ ì¤‘ìš”í•œ ë‹¨ì„œì…ë‹ˆë‹¤.</div>
                <div class="tuto-visual">5 + 1 = <span style="color:#e67e22">6</span> ğŸ”Š</div>
                <div class="tuto-desc">ìˆ«ìê°€ <span class="highlight">5 ì´ìƒ</span>ì´ë‹¤? ğŸ‘‰ <b>ë°”ë¡œ ê·¼ì²˜(ìœ„/ì˜†)ì— ë²”ì¸ì´ ìˆë‹¤</b>ëŠ” ëœ»ì…ë‹ˆë‹¤.<br>ë§Œì•½ <b>6</b>ì´ë¼ë©´? ì˜†ì— í•œ ëª…(5), ë©€ë¦¬ í•œ ëª…(1)ì´ ìˆë‹¤ëŠ” ëœ»ì´ì£ !</div>
            </div>
            <div class="tuto-step" id="step-3">
                <div class="tuto-desc"><b>ğŸ¤ í°ìƒ‰ ì°½ë¬¸ì€ ì•ˆì „ì§€ëŒ€</b>ì…ë‹ˆë‹¤.<br>ì†ŒìŒì´ 0ì¸ ê³³ì€ ë§ˆìŒê» ëˆ„ë¥´ì„¸ìš”.</div>
                <div class="tuto-visual" style="background:white; border:2px solid #eee;">ğŸ¤ ì•ˆì „ (0dB)</div>
                <div class="tuto-desc">ë²”ì¸ì„ ì¡ìœ¼ë©´(ê²€ê±°),<br>ê·¸ ë²”ì¸ì˜ <b>ìƒí•˜ì¢Œìš°ëŠ” 100% ì•ˆì „</b>í•´ì§‘ë‹ˆë‹¤.</div>
            </div>
            <div class="tuto-step" id="step-4">
                <div class="tuto-desc">ì, ì´ì œ ì¶œë™í•©ì‹œë‹¤!<br>í•˜ë‹¨ ë²„íŠ¼ìœ¼ë¡œ ëª¨ë“œë¥¼ ë³€ê²½í•˜ì„¸ìš”.</div>
                <div class="tuto-visual"><span style="color:#f1c40f">ğŸ” ì¡°ì‚¬</span> vs <span style="color:#e74c3c">ğŸ‘® ê²€ê±°</span></div>
                <div class="tuto-desc">ì‹¤ìˆ˜ë¡œ <span class="highlight">ë²”ì¸</span>ì„ ì¡°ì‚¬í•˜ê±°ë‚˜ <span class="highlight">ì–µìš¸í•œ ì‹œë¯¼</span>ì„ ì¡ìœ¼ë©´<br><b>í•˜íŠ¸ê°€ ê¹ì…ë‹ˆë‹¤!</b> ëŒ€ì‹  ë²”ì¸ì€ ê²€ê±°ëœ ê²ƒìœ¼ë¡œ ì¸ì •í•´ì¤ë‹ˆë‹¤.</div>
            </div>
            <div class="tuto-step" id="step-5">
                <div class="tuto-desc">íŠ¹ìˆ˜ ì„ë¬´: <span class="highlight">ğŸšï¸ì •ë³´ì œí•œ(ë¹ˆì§‘)</span><br>ğŸš« í‘œì‹œëŠ” ë²”ì¸ì´ ì‚´ì§€ ì•ŠëŠ” **ì•ˆì „í•œ ë¹ˆì§‘**ì…ë‹ˆë‹¤.</div>
                <div class="tuto-visual">ğŸšï¸ ğŸš« (ì•ˆì „ êµ¬ì—­)</div>
                <div class="tuto-desc">í•˜ì§€ë§Œ ì„¼ì„œê°€ ì—†ì–´ ì†ŒìŒ ìˆ˜ì¹˜ë¥¼ ì§ì ‘ ë³´ì—¬ì£¼ì§€ ì•ŠìŠµë‹ˆë‹¤!<br>ì£¼ë³€ ì§‘ë“¤ì˜ ìˆ«ìë¥¼ ì¡°í•©í•´ ë¹ˆì§‘ ë„ˆë¨¸ë¥¼ ì—­ì¶”ë¡ í•˜ì„¸ìš”!</div>
            </div>
            <div class="tuto-step" id="step-6">
                <div class="tuto-desc">íŠ¹ìˆ˜ ì„ë¬´: <span class="highlight">ğŸŒ¡ï¸ì—´ê°ì§€ìˆ˜ì‚¬(íˆíŠ¸ë§µ)</span><br>ìˆ«ì ëŒ€ì‹  **ì†ŒìŒì˜ ì˜¨ë„**ë¥¼ í™•ì¸í•˜ëŠ” ê³ ë„ ìˆ˜ì‚¬ ê¸°ë²•ì…ë‹ˆë‹¤.</div>
                <div class="tuto-visual" style="font-size: 0.9rem; text-align: left; background: #fff; padding: 10px;">
                    <div style="background:#2980b9; color:white; padding:4px; margin:2px;">ğŸŸ¦ íŒŒë‘: 0dB (ì™„ì „ ê³ ìš”)</div>
                    <div style="background:#f1c40f; color:black; padding:4px; margin:2px;">ğŸŸ¨ ë…¸ë‘: 1~4dB (ë©€ë¦¬ ëˆ„êµ°ê°€ ìˆìŒ)</div>
                    <div style="background:#e67e22; color:white; padding:4px; margin:2px;">ğŸŸ§ ì£¼í™©: 5~9dB (ì˜†ì§‘ì— ë²”ì¸!)</div>
                    <div style="background:#c0392b; color:white; padding:4px; margin:2px;">ğŸŸ¥ ë¹¨ê°•: 10dBâ†‘ (í¬ìœ„ ë‹¹í•¨!)</div>
                </div>
                <div class="tuto-desc">ìƒ‰ê¹”ë§Œ ë³´ê³  ë²”ì¸ì„ íŠ¹ì •í•˜ì„¸ìš”! ë²”ì¸ì„ ê²€ê±°í•˜ë©´ ìƒ‰ê¹” ìœ„ì— ğŸ‘® í‘œì‹œê°€ ë‚˜íƒ€ë‚©ë‹ˆë‹¤! ì°!</div>
            </div>
            <div class="modal-footer">
                <button class="btn-prev" onclick="prevStep()">â—€ ì´ì „</button>
                <button class="btn-next" onclick="nextStep()">ë‹¤ìŒ â–¶</button>
            </div>
        </div>
    </div>

    <div class="ui-panel" id="ui-panel">
        <div class="header-row">
            <h1>ğŸ¢ ì¸µê°„ìˆ˜ì‚¬ëŒ€ M</h1>
            <button class="btn-restart-big" onclick="initGame()">ğŸ”„ ë‹¤ì‹œ ì‹œì‘</button>
        </div>
        <div class="difficulty-bar">
            <button class="btn-diff active" onclick="setDifficulty('easy', this)">ì´ˆê¸‰</button>
            <button class="btn-diff" onclick="setDifficulty('normal', this)">ì¤‘ê¸‰</button>
            <button class="btn-diff" onclick="setDifficulty('hard', this)">ê³ ê¸‰</button>
            <button class="btn-diff master" onclick="setDifficulty('master', this)">ìµœê³ ê¸‰</button>
            <button class="btn-diff abyss" onclick="setDifficulty('abyss', this)">ğŸ’€ì‹¬ì—°</button>
            <button class="btn-diff abyss2" onclick="setDifficulty('abyss2', this)">â™¾ï¸ì‹¬ì—°2</button>
            <button class="btn-diff empty-mode" onclick="setDifficulty('empty', this)">ğŸšï¸ì •ë³´ì œí•œ</button>
            <button class="btn-diff heatmap-mode" onclick="setDifficulty('heatmap', this)">ğŸŒ¡ï¸ì—´ê°ì§€</button>
        </div>
        <div class="status-bar">
            <div id="lives">â¤ï¸â¤ï¸â¤ï¸</div>
            <div>ê²€ê±°: <span id="score" class="score-num">0</span> <span id="total-criminals">/ 5</span></div>
        </div>
    </div>

    <div class="game-container">
        <div class="building-container">
            <div class="roof"></div>
            <div id="game-board"></div>
        </div>
    </div>

    <div class="controls" id="controls">
        <button id="btn-mode-investigate" class="mode-btn btn-investigate active" onclick="setMode('investigate')">ğŸ” ì¡°ì‚¬í•˜ê¸°</button>
        <button id="btn-mode-arrest" class="mode-btn btn-arrest" onclick="setMode('arrest')">ğŸ‘® ê²€ê±°í•˜ê¸°</button>
    </div>

    <script>
        let currentStep = 0;
        const totalSteps = 7;
        function updateTutorial() {
            for(let i=0; i<totalSteps; i++) document.getElementById(`step-${i}`).classList.toggle('active', i === currentStep);
            document.querySelector('.btn-prev').style.visibility = (currentStep === 0) ? 'hidden' : 'visible';
            document.querySelector('.btn-next').innerText = (currentStep === totalSteps - 1) ? "ì‘ì „ ì‹œì‘! ğŸ˜ì°" : "ë‹¤ìŒ â–¶";
        }
        function nextStep() { if(currentStep < totalSteps - 1) { currentStep++; updateTutorial(); } else { document.getElementById('tutorial-modal').style.display = 'none'; } }
        function prevStep() { if(currentStep > 0) { currentStep--; updateTutorial(); } }

        const DIFFICULTIES = { 
            easy: { rows: 6, cols: 5, criminals: 5, emptyRate: 0, isHeat: false }, 
            normal: { rows: 8, cols: 6, criminals: 8, emptyRate: 0, isHeat: false }, 
            hard: { rows: 10, cols: 8, criminals: 13, emptyRate: 0, isHeat: false },
            master: { rows: 12, cols: 10, criminals: 20, emptyRate: 0, isHeat: false },
            abyss: { rows: 15, cols: 12, criminals: 40, emptyRate: 0, isHeat: false },
            abyss2: { rows: 20, cols: 15, criminals: 70, emptyRate: 0, isHeat: false },
            empty: { rows: 10, cols: 8, criminals: 13, emptyRate: 0.25, isHeat: false },
            heatmap: { rows: 10, cols: 8, criminals: 14, emptyRate: 0, isHeat: true } 
        };
        let currentDiff = DIFFICULTIES.easy;
        let grid = [], lives = 3, caught = 0, isFirstClick = true, currentMode = 'investigate', gameOver = false;

        function handleResize() {
            if (!currentDiff) return;
            const uiPanelHeight = document.getElementById('ui-panel').offsetHeight;
            const controlsHeight = document.getElementById('controls').offsetHeight;
            const finalSize = Math.min((window.innerWidth - 60) / currentDiff.cols, (window.innerHeight - uiPanelHeight - controlsHeight - 60) / currentDiff.rows, 60);
            document.documentElement.style.setProperty('--cell-size', Math.floor(finalSize) + 'px');
            document.documentElement.style.setProperty('--cols', currentDiff.cols);
        }
        window.addEventListener('resize', handleResize);

        function setDifficulty(level, btn) {
            document.querySelectorAll('.btn-diff').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            currentDiff = DIFFICULTIES[level];
            handleResize();
            initGame();
        }

        function initGame() {
            grid = []; lives = 3; caught = 0; isFirstClick = true; gameOver = false;
            updateUI();
            document.getElementById('total-criminals').innerText = "/ " + currentDiff.criminals;
            document.getElementById('game-board').innerHTML = '';
            for(let r=0; r<currentDiff.rows; r++){
                for(let c=0; c<currentDiff.cols; c++){
                    let cell = document.createElement('div');
                    cell.className = 'window'; cell.dataset.r = r; cell.dataset.c = c;
                    cell.innerHTML = `<div class="noise-icon"></div><div class="val"></div>`;
                    cell.onclick = () => handleInput(r, c, cell, 'left');
                    cell.oncontextmenu = (e) => { e.preventDefault(); handleInput(r, c, cell, 'right'); };
                    document.getElementById('game-board').appendChild(cell);
                }
            }
            handleResize();
        }

        function setMode(mode) {
            currentMode = mode;
            document.getElementById('btn-mode-investigate').classList.toggle('active', mode === 'investigate');
            document.getElementById('btn-mode-arrest').classList.toggle('active', mode === 'arrest');
        }

        function generateMap(safeR, safeC) {
            grid = [];
            for(let r=0; r<currentDiff.rows; r++){
                let row = [];
                for(let c=0; c<currentDiff.cols; c++) row.push({ isCriminal: false, isEmpty: false, noise: 0, revealed: false, checked: false });
                grid.push(row);
            }
            let placed = 0;
            while(placed < currentDiff.criminals) {
                let r = Math.floor(Math.random() * currentDiff.rows), c = Math.floor(Math.random() * currentDiff.cols);
                if(Math.abs(r - safeR) <= 1 && Math.abs(c - safeC) <= 1) continue;
                if(grid[r][c].isCriminal) continue;
                grid[r][c].isCriminal = true; placed++;
            }
            // â­ ë¹ˆì§‘ ë¡œì§: ë²”ì¸ì´ ì•„ë‹Œ ê³³ì—ë§Œ ë°°ì¹˜
            if(currentDiff.emptyRate > 0) {
                for(let r=0; r<currentDiff.rows; r++)
                    for(let c=0; c<currentDiff.cols; c++)
                        if(!grid[r][c].isCriminal && Math.random() < currentDiff.emptyRate && (r !== safeR || c !== safeC)) grid[r][c].isEmpty = true;
            }
            const dirs = [{dr:1, dc:0}, {dr:0, dc:-1}, {dr:0, dc:1}];
            for(let r=0; r<currentDiff.rows; r++)
                for(let c=0; c<currentDiff.cols; c++)
                    if(grid[r][c].isCriminal) dirs.forEach(d => { addNoise(r+d.dr, c+d.dc, 5); addNoise(r+d.dr*2, c+d.dc*2, 1); });
        }
        function addNoise(r, c, v) { if(r>=0 && r<currentDiff.rows && c>=0 && c<currentDiff.cols) grid[r][c].noise += v; }

        function handleInput(r, c, el, inputType) {
            if(gameOver) return;
            if(isFirstClick) { generateMap(r, c); isFirstClick = false; revealCell(r, c); return; }
            let cell = grid[r][c]; if(cell.revealed || cell.checked) return;
            let action = (inputType === 'right') ? 'arrest' : currentMode;

            if(action === 'investigate') {
                if(cell.isCriminal) {
                    lives--; caught++; updateUI(); cell.checked = true; el.classList.add('busted'); el.querySelector('.noise-icon').innerText = "ğŸ‘¹";
                    openSafeNeighbors(r, c);
                    if(lives <= 0) { gameOver = true; alert("ìˆ˜ì‚¬ ì‹¤íŒ¨! ğŸ˜­"); }
                    else if(caught === currentDiff.criminals) alert("ì˜¬ê²€ê±° ì„±ê³µ! ğŸ˜");
                } else revealCell(r, c);
            } else {
                if(cell.isCriminal) {
                    cell.checked = true; el.classList.add('arrested'); el.querySelector('.noise-icon').innerText = "ğŸ‘®â€â™‚ï¸"; caught++; updateUI(); openSafeNeighbors(r, c);
                    if(caught === currentDiff.criminals) alert("ì˜¬ê²€ê±° ì„±ê³µ! ğŸ˜");
                } else {
                    lives--; updateUI(); el.classList.add('angry');
                    setTimeout(() => { el.classList.remove('angry'); revealCell(r, c); }, 600);
                    if(lives <= 0) { gameOver = true; alert("í•´ê³ ë˜ì—ˆìŠµë‹ˆë‹¤! ğŸ’”"); }
                }
            }
        }

        function revealCell(r, c) {
            let cell = grid[r][c]; if(cell.revealed) return;
            cell.revealed = true; let el = document.querySelector(`.window[data-r='${r}'][data-c='${c}']`);
            el.classList.add('revealed');
            if(cell.isEmpty) { el.classList.add('empty-house'); el.querySelector('.noise-icon').innerText = "ğŸš«"; return; }
            if(currentDiff.isHeat) {
                let h = cell.noise >= 10 ? 3 : (cell.noise >= 5 ? 2 : (cell.noise > 0 ? 1 : 0));
                el.classList.add(`h-${h}`);
                if(h === 0) floodFill(r, c);
                return;
            }
            if(cell.noise > 0) {
                let lv = cell.noise >= 10 ? 3 : (cell.noise >= 5 ? 2 : 1);
                el.classList.add(`level-${lv}`); el.querySelector('.val').innerText = cell.noise;
                el.querySelector('.noise-icon').innerText = ["ğŸ”ˆ", "ğŸ”Š", "ğŸ”¥"][lv-1];
            } else { el.classList.add('safe'); el.querySelector('.noise-icon').innerText = "ğŸ¤"; floodFill(r, c); }
        }

        function floodFill(r, c) {
            [[0,1],[0,-1],[1,0],[-1,0], [1,1],[1,-1],[-1,1],[-1,-1]].forEach(([dr, dc]) => {
                let nr=r+dr, nc=c+dc;
                if(nr>=0 && nr<currentDiff.rows && nc>=0 && nc<currentDiff.cols && !grid[nr][nc].isCriminal && !grid[nr][nc].revealed) revealCell(nr, nc);
            });
        }
        function openSafeNeighbors(r, c) {
            [[0,1],[0,-1],[1,0],[-1,0]].forEach(([dr, dc]) => {
                let nr=r+dr, nc=c+dc;
                if(nr>=0 && nr<currentDiff.rows && nc>=0 && nc<currentDiff.cols && !grid[nr][nc].revealed && !grid[nr][nc].checked) {
                    if(grid[nr][nc].isCriminal) {
                        let target = document.querySelector(`.window[data-r='${nr}'][data-c='${nc}']`);
                        target.classList.add('revealed', 'busted'); target.querySelector('.noise-icon').innerText = "ğŸ‘¹";
                    } else revealCell(nr, nc);
                }
            });
        }
        function updateUI() {
            let h = ""; for(let i=0; i<3; i++) h += (i < lives ? "â¤ï¸" : "ğŸ’”");
            document.getElementById('lives').innerHTML = h; document.getElementById('score').innerText = caught;
        }

        setDifficulty('easy', document.querySelector('.btn-diff.active'));
        updateTutorial(); 
    </script>
</body>
</html>
